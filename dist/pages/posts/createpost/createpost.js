"use strict";(wx["webpackJsonp"]=wx["webpackJsonp"]||[]).push([[559],{8495:function(e,t,r){var n=r(2180),a=r(4165),s=r(3433),c=r(5861),o=r(9439),u=r(7294),i=r(2954),l=r.n(i),p=r(1515),h=r(1798),f=r.n(h),m=r(5260),d=r(6657),x=r(1928),g=r(4404),v=r(5063),w=function(){var e=(0,c.Z)((0,a.Z)().mark((function e(t,r,n,s){var o,u,i,p,h,f;return(0,a.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return o=l().getStorageSync("policy"),u=l().getStorageSync("signature"),i=t,p=[],h=s.map(function(){var e=(0,c.Z)((0,a.Z)().mark((function e(t){var s,c;return(0,a.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return s="postImage-".concat(r,"-").concat(Date.now()),p.push(s),e.t0=l(),e.t1=n,e.next=6,(0,v.Z)(t);case 6:return e.t2=e.sent,e.t3={key:s,policy:o,OSSAccessKeyId:i,signature:u},e.t4={url:e.t1,filePath:e.t2,name:"file",formData:e.t3},c=e.t0.uploadFile.call(e.t0,e.t4),e.abrupt("return",c);case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=7,Promise.all(h);case 7:return f=e.sent,e.abrupt("return",{ossRes:f,filenames:p});case 9:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}(),b=r(79),k=r(5893);function Z(){var e=(0,m.Z)((function(e){return e.statusBarHeight})),t=(0,d.Z)((function(e){return[e.requestUrl,e.OSSUrl]})),r=(0,o.Z)(t,2),n=r[0],i=r[1],h=(0,g.Z)((function(e){return e.id})),v=(0,x.Z)((function(e){return e.accessKey_id})),Z=(0,u.useState)(["\u6821\u56ed\u65e5\u5e38","\u65b0\u751f","\u6c42\u52a9","\u4ea4\u53cb","\u8003\u7814","\u5b9e\u4e60\u517c\u804c"]),y=(0,o.Z)(Z,2),j=y[0],N=(y[1],(0,u.useState)()),S=(0,o.Z)(N,2),T=S[0],G=S[1],P=(0,u.useState)([]),C=(0,o.Z)(P,2),I=C[0],F=C[1],O=(0,u.useRef)(null),R=(0,u.useRef)(null);function z(e){G(e)}function B(){return E.apply(this,arguments)}function E(){return E=(0,c.Z)((0,a.Z)().mark((function e(){var t;return(0,a.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,l().chooseImage({count:9-I.length,sourceType:["album","camera"],sizeType:["compressed"]});case 2:if(t=e.sent,0!==t.tempFilePaths.length){e.next=5;break}return e.abrupt("return");case 5:F([].concat((0,s.Z)(I),(0,s.Z)(t.tempFilePaths)));case 6:case"end":return e.stop()}}),e)}))),E.apply(this,arguments)}function A(e){var t=(0,s.Z)(I);t.splice(e,1),F(t)}function D(){return J.apply(this,arguments)}function J(){return J=(0,c.Z)((0,a.Z)().mark((function e(){var t,r,s,c,o,u,p;return(0,a.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,!O.current||!R.current){e.next=36;break}if(!(O.current.value.length>25)){e.next=7;break}return l().showToast({title:"\u6807\u9898\u8d85\u51fa\u957f\u5ea6",icon:"error"}),e.abrupt("return");case 7:if(!(R.current.value.length>1e3)){e.next=12;break}return l().showToast({title:"\u5185\u5bb9\u8d85\u51fa\u957f\u5ea6",icon:"error"}),e.abrupt("return");case 12:if(!(O.current.value.length<1||R.current.value.length<1)){e.next=17;break}return l().showToast({title:O.current.value.length<1?"\u8bf7\u586b\u5199\u6807\u9898":"\u8bf7\u586b\u5199\u5185\u5bb9",icon:"error"}),e.abrupt("return");case 17:if(""!==T&&void 0!==T){e.next=20;break}return l().showToast({title:"\u8bf7\u9009\u62e9\u8bdd\u9898",icon:"error"}),e.abrupt("return");case 20:return t=O.current.value,r=R.current.value,s=T,c=I,e.next=26,w(v,h,i,c);case 26:return o=e.sent,o.ossRes.forEach((function(e,t){if(204!==e.statusCode)throw l().showToast({title:"\u4e0a\u4f20\u5931\u8d25: ".concat(t+1),icon:"error"}),new Error("image upload failed")})),u=o.filenames.map((function(e){return"".concat(i,"/").concat(e)})),console.log(u),l().showLoading({title:"\u53d1\u5e03\u4e2d",mask:!0}),e.next=33,(0,b.$)({method:"POST",url:n,path:"/api/v1/posts/",data:{title:t,content:r,pictures:u,tag:s},header:{authorization:l().getStorageSync("token")}});case 33:p=e.sent,201===p.statusCode?(l().showToast({title:"\u53d1\u5e03\u6210\u529f",icon:"success"}),setTimeout((function(){l().navigateBack(),f().publish("refreshPage")}),1500)):l().showToast({title:"\u53d1\u5e03\u5931\u8d25",icon:"none"});case 36:e.next=42;break;case 39:return e.prev=39,e.t0=e["catch"](0),e.abrupt("return",e.t0);case 42:case"end":return e.stop()}}),e,null,[[0,39]])}))),J.apply(this,arguments)}return(0,k.jsxs)(p.G7,{className:"createpost-wrapper",style:{paddingTop:e+"px"},children:[(0,k.jsxs)(p.G7,{className:"createpost-header",children:[(0,k.jsx)(p.G7,{className:"createpost-header-back",onClick:function(){l().navigateBack()}}),(0,k.jsx)(p.xv,{className:"createpost-header-title",children:"\u53d1\u5e03"})]}),(0,k.jsxs)("form",{className:"createpost-form",children:[(0,k.jsx)(p.II,{ref:O,className:"createpost-title",type:"text",name:"title",placeholder:"\u586b\u5199\u6807\u9898\u4f1a\u66f4\u53d7\u6b22\u8fce\u54e6\uff01\uff08\u5c0f\u4e8e25\u5b57\uff09"}),(0,k.jsx)("textarea",{ref:R,className:"createpost-content",name:"content",placeholder:"\u6dfb\u52a0\u6b63\u6587\uff08\u5c0f\u4e8e1000\u5b57\uff09",maxLength:1e3}),(0,k.jsxs)(p.G7,{className:"createpost-uploadPic-area",children:[I.map((function(e,t){return(0,k.jsxs)(p.G7,{className:"createpost-selectedImage-wrapper",children:[(0,k.jsx)("img",{className:"createpost-selectedImage",src:e,alt:"Selected-".concat(t)}),(0,k.jsx)(p.G7,{className:"createpost-delete-btn",onClick:function(){return A(t)},children:"\xd7"})]},t)})),I.length<9&&(0,k.jsx)(p.G7,{className:"createpost-uploadPic-btn",onClick:B})]}),(0,k.jsxs)(p.G7,{className:"createpost-postTags",children:[(0,k.jsx)(p.xv,{children:"\u9009\u62e9\u8bdd\u9898*"}),(0,k.jsx)(p.xv,{children:"\u8bdd\u9898\u51b3\u5b9a\u4e86\u4f60\u53d1\u5e03\u7684\u5185\u5bb9\u662f\u5426\u4f1a\u4f60\u6240\u671f\u671b\u7684\u540c\u5b66\u770b\u5230"}),(0,k.jsx)(p.G7,{className:"createpost-tags",children:j.map((function(e,t){return(0,k.jsx)(p.G7,{className:"createpost-tag",onClick:function(){return z(e)},style:{backgroundColor:T===e?"#4E6AFF":"#efefef",color:T===e?"#fff":"#8b8b8b"},children:e},t)}))})]}),(0,k.jsx)(p.zx,{className:"createpost-submit",formType:"submit",onClick:D,children:"\u53d1\u5e03"})]})]})}var y={};Page((0,n.createPageConfig)(Z,"pages/posts/createpost/createpost",{root:{cn:[]}},y||{}))}},function(e){var t=function(t){return e(e.s=t)};e.O(0,[107,216,592],(function(){return t(8495)}));e.O()}]);